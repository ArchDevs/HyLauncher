# API Integration Project Documentation

## Project Overview
This document describes the implementation of a new backend API for the HyLauncher game's patch management system. The goal was to replace the old method of downloading game files with a new API-based approach.

## Original Goal
Replace the old patch downloading method (direct downloads from `game-patches.hytale.com`) with a new custom backend API (`api.hylauncher.fun/v1/pwr`) that provides patch steps for incremental upgrades.

## API Specification

### Endpoint
```
GET https://api.hylauncher.fun/v1/pwr
```

### Request Body (example)
```json
{
  "os": "linux",
  "arch": "amd64",
  "branch": "release",
  "version": "0"
}
```

**Note:** `version` is the CURRENT installed version. Use "0" for fresh installs.

### Response Format
```json
{
  "steps": [
    {
      "from": 3,
      "to": 5,
      "pwr": "https://game-patches.hytale.com/patches/linux/amd64/release/3/5.pwr?verify=...",
      "pwrHead": "https://game-patches.hytale.com/patches/linux/amd64/release/3/5.pwr?verify=...",
      "sig": "https://game-patches.hytale.com/patches/linux/amd64/release/3/5.pwr.sig?verify=..."
    },
    {
      "from": 5,
      "to": 6,
      "pwr": "...",
      "pwrHead": "...",
      "sig": "..."
    }
  ]
}
```

## Implementation Details

### 1. Backend Changes

#### `internal/patch/pwr_patcher.go`
- Added API types: `PatchRequest`, `PatchStepsResponse`, `PatchStep`
- Implemented `DownloadAndApplyPWR()` function that:
  1. Fetches patch steps from the API
  2. Downloads PWR and signature files for each step
  3. Applies patches sequentially using Butler
  4. Stops at the target version if specified

#### `internal/patch/version.go`
- Replaced binary search version checking with API calls
- `FindLatestVersion()`: Calls API with version 1, returns last step's `to` version
- `ListAllVersions()`: Calls API with version 1, extracts all unique versions from steps

#### `internal/service/game_service.go`
- Updated `installInternal()` to use `DownloadAndApplyPWR()`
- For AUTO version: reads current version from `.version` file and patches incrementally
- For specific versions: patches from version 0 (fresh install)

#### `internal/app/game.go`
- Changed `DownloadAndLaunch` and `DownloadAndLaunchWithServer` to return `string` instead of `error`
- Changed `GetReleaseVersions` and `GetPreReleaseVersions` to return `VersionsResponse` struct
- This prevents cyclic reference errors when Wails serializes data for the frontend

### 2. Frontend Changes

#### `frontend/src/hooks/useLauncher.ts`
- Updated to handle `VersionsResponse` struct (with `versions` and `error` fields)
- Updated `handlePlay` to check error string returned from launch functions
- Updated version fetching to handle the new response format

## Problems Encountered
- `GetReleaseVersions() VersionsResponse` - returns struct with error string field

### 4. Version Listing
**Problem:** The API doesn't directly list all available versions.

**Solution:** Call API with version 1, which returns all steps from version 1 to latest. Extract unique version numbers from the `from` and `to` fields of all steps.

## Key Design Decisions

### Incremental Patching
The system patches step-by-step (e.g., 3→5→6→7→8) rather than downloading full versions. This is more efficient for updates.

### AUTO Version Management
- AUTO always points to the latest version
- When a new version is released, AUTO patches from its current version to the new latest
- Version number is stored in `.version` file in the game directory

### Error Handling
All errors are converted to strings before crossing the Go→JavaScript boundary to prevent serialization issues.

## Files Modified

### Backend
- `internal/patch/pwr_patcher.go` - Core patching logic
- `internal/patch/version.go` - Version checking via API
- `internal/service/game_service.go` - Installation orchestration
- `internal/app/game.go` - App methods with string error returns

### Frontend
- `frontend/src/hooks/useLauncher.ts` - Handle new response types
- `frontend/src/pages/Home.tsx` - Fix event handler

## Testing Notes

1. **Fresh Install (version 0):** Should download all patches from 0 to latest
2. **Update (AUTO):** Should read current version and patch incrementally
3. **Specific Version:** Should patch from 0 to target version
4. **Version Listing:** Should display all available versions in dropdown

## Future Improvements

1. Add caching for API responses to reduce API calls
2. Implement retry logic for failed patch downloads
3. Add progress tracking for each patch step
4. Consider implementing delta patches for even smaller downloads

## Lessons Learned

1. **Never pass Go error types to JavaScript** - Always convert to strings
2. **Be careful with React event handlers** - Always use arrow functions to prevent event propagation
3. **Understand the existing logic before modifying** - The AUTO version logic was already correct
4. **Test incrementally** - Make small changes and test rather than large refactors

## API Endpoint Details

The API is hosted at `https://api.hylauncher.fun/v1/pwr` and accepts GET requests with a JSON body containing:
- `os`: Operating system (linux, windows, darwin)
- `arch`: Architecture (amd64, arm64)
- `branch`: Game branch (release, pre-release)
- `version`: Current installed version as string ("0" for fresh install)

The response contains an array of patch steps, each with URLs to download the PWR file, PWR head, and signature file.

## Additional instructions
Analyze existing code and try to write in same style. Do NOT edit/write that is not asked to do